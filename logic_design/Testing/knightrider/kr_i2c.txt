lui x2, 18 /*i2c addr*/
addi x3, x0, 1 /*nby*/
addi x4, x0, 123 /*slave addr*/
addi x5, x0, 1 /*tdr*/
addi x6, x0, 1 /*cfg*/
addi x7, x0, 128 /*const*/
sw x3, 0(x2) /*write nby*/
sw x4, 4(x2) /*write slave addr*/
/*ignore rdr since we dont read*/

to_left:
jal x1, call_i2c
slli x5, x5, 1
bne x7, x5, to_left

to_right:
jal x1, call_i2c
srli x5, x5, 1
bne x5, x6, to_right /*x6 is used because it is const 1 although x6 is not related*/
jal x0, to_left

call_i2c:
sw x5, 12(x2) /*write tdr*/
sw x6, 16(x2) /*write cfg*/
wait_i2c:
lw x8, 16(x2) /*load cfg*/
andi x8, x8, 10 /*bitmask CFG[1] and CFG[3]*/
beq x8, x0, wait_i2c /*check whether the transmission is finished or not*/
jalr x0, x1, 0 /*return*/